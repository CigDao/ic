# This file will be included in the child pipeline if there ARE changes in the /rs or /ic-os/guestos folder
#
# - all jobs included transitively from this file (keys not starting with dot) will run.
# - additional `cargo test` jobs will be generated for some crates by `src/gen_gitlab_cargo_pipeline`

include:
- local: /gitlab-ci/config/00--common.yml
- local: /gitlab-ci/config/20--wait-for-parent-pipeline-jobs.yml
- local: /gitlab-ci/config/20--test--docker-build-ic.yml
- local: /gitlab-ci/config/20--test--after-script.yml
- local: /gitlab-ci/config/30--cargo-build--child-pipeline.yml
- local: /gitlab-ci/config/40--cargo-test--child-pipeline.yml
- local: /gitlab-ci/config/46--guest-os-build--guest-base-image.yml
- local: /gitlab-ci/config/46--guest-os-build--guest-os-updateimg.yml
- local: /gitlab-ci/config/46--rosetta-api-docker-image.yml
- local: /gitlab-ci/config/47--guest-os-test--guest-os-e2e-test.yml
- local: /gitlab-ci/config/47--guest-os-test--e2e-scalability.yml
- local: /gitlab-ci/config/52--host-os-build--host-base-image.yml
- local: /gitlab-ci/config/52--host-os-build--host-os-diskimg.yml
- local: /gitlab-ci/config/52--host-os-build--host-os-updateimg.yml
- local: /gitlab-ci/config/53--host-os-build--setupos-base-image.yml
- local: /gitlab-ci/config/53--host-os-build--build-setupos.yml
- local: /gitlab-ci/config/55--determinism-test.yml

.cargo-build-docker-protected:
  needs: []  # don't wait on other jobs by default
  extends:
    - .ubuntu-docker-k8s-protected
    - .rules-parent-pipeline
  stage: cargo-build

.cargo-build-docker:
  needs: []  # don't wait on other jobs by default
  extends:
    - .ubuntu-nix-docker-k8s-pinned-dc
    - .rules-parent-pipeline
  stage: cargo-build

.cargo-build-macos:
  needs: []  # don't wait on other jobs by default
  extends:
    - .macos-nix-native
    - .rules-parent-pipeline-protected-branch-only
  stage: cargo-build
